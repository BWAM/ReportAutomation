---
title: "Section 1 b) BAP metrics"
author: 'NYSDEC SMAS : Keleigh Reynolds'
date: "4/10/2020"
output:
  word_document: default
---



```{r message=FALSE,warning=FALSE, echo=FALSE}
#Andrea's simplified code for only a single point per site
library(tidyverse)

#set up the file path to the metrics data
file.path=file.path(here::here(),
          "data",
          "metrics.csv")

file.path.s<-file.path(here::here(),
                       "data",
                       "sites_wallkill.csv")

metrics.df<-read.csv(file.path,stringsAsFactors = FALSE)
sites<-read.csv(file.path.s,stringsAsFactors = FALSE)
```

```{r message=FALSE,warning=FALSE, echo=FALSE}
sum.metrics<-metrics.df%>%
  filter(year>2016)%>%
  rename(BAP=MMDH_BIO_ASMT_PROFILE_SCORE)%>%
  group_by(SITE_ID, SH_PWL_ID)%>%
  summarise(mean=mean(BAP, na.rm = TRUE),
            N=n(),
            sd=sd(BAP, na.rm = TRUE))%>%
  mutate(se=sd/sqrt(N),
         ci=qt(1 - ((1 - 0.95) / 2), N - 1) * se)%>%
  rename(PWL_ID=SH_PWL_ID)
```

```{r message=FALSE,warning=FALSE, echo=FALSE}
#reorder SITE IDS based on order column in sites table
sites<-sites%>%
  rename(SITE_ID=SH_SITE_ID)

sum.metrics<-left_join(sum.metrics, sites, by="SITE_ID")

sum.metrics$SITE_ID<-fct_reorder(sum.metrics$SITE_ID, sum.metrics$order)
sum.metrics$PWL_ID<-fct_reorder(sum.metrics$PWL_ID, sum.metrics$order)

```



```{r BAP, fig.width=7,fig.height=7, message=FALSE, warning=FALSE, echo=FALSE, fig.cap="Biological Assessment Profile (BAP) Scores and 95% confidence intervals for benthic macroinvertebrate community assessment data for the Wallkill River Survey, 2017-2019. Symbology corresponds with WI/PWL segmentation as indicated in the plot legend."}
#create labels
l<-length(sum.metrics$SITE_ID)

pwl.l<-unique(sum.metrics$PWL_ID)
l.p<-length(pwl.l)

labels.df <- data.frame(
  label = c("Non", "Slight", "Moderate", "Severe"),
  x = max(l)+1,
  y = c(8.75, 6.25, 3.75, 1.25),
  stringsAsFactors = FALSE)


ggplot(sum.metrics, aes(SITE_ID, y=mean))+
  geom_point(aes( shape=PWL_ID, color=group), size=4)+
  scale_shape_manual(name="PWL Segment ID",values = 0:max(l.p))+
  geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci, color=group,),  width=.5)+
  theme_bw() + 
  theme(
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),#remove gridlines
  axis.title.y = element_text(
    size = 12,
    family = "serif",
    face = "bold"),
  axis.title.x = element_blank(),
  axis.text.x = element_text(
    angle = 45,
    hjust = 1,
    size = 10,
    family = "serif"), #rotate text angle
  plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),
  legend.position = c(.11, .81) + #reduces white space around plot edges
    geom_label(aes(x = .5, y = .5), label = "test")
)+
  geom_hline(yintercept=2.5,linetype="dashed",color="grey")+
  geom_hline(yintercept=5,linetype="dashed",color="grey")+
  geom_hline(yintercept=7.5,linetype="dashed",color="grey")+
  ylab("Biological Assessment Profile Score")+xlab("Year")+ geom_text(data = labels.df, aes(max(l)+1, y, label = label), color = "black",angle=90)+
  expand_limits(y=c(0,10),x=c(0:max(l+2)))


```


`