---
title: "Section 1 a) chemistry and stream discharge"
author: 'NYSDEC SMAS : Keleigh Reynolds'
date: "4/10/2020"
output: 
word_document: default
---

```{r include=FALSE, message=FALSE,warning=FALSE}

#set up the file path
file.path=file.path(here::here(),
          "data",
          "chemistry.csv")

#for the table
file.path.1<-file.path(here::here(),
                       "data",
                       "qaqc_analyte_table.csv")


```

```{r include=FALSE,message=FALSE,warning=FALSE}
#Read in the data needed for the section

#analyte table
analyte<-read.csv(file.path.1,stringsAsFactors = FALSE)

#read in the chemistry file
chem_all<-read.csv(file.path,stringsAsFactors = FALSE)

#read in the sites table
sites<-read.csv(file.path(here::here(),
                          "data",
                          "sites_wallkill.csv"),stringsAsFactors = FALSE)


          
```

## Analyte Table

```{r tab.id= "Analytes", tab.cap="Water chemistry analytes sampled as part of the Wallkill River Stream Assessment Survey. Table lists sampled analytes and analytical specifications. ^ Precision objectives are defined by results of duplicate samples as described in Appendix III", echo=FALSE, message=FALSE, warning=FALSE}

library(dplyr)
library(flextable)

#create table for the analyte list/precision method etc
tl.1<-analyte %>% 
  rename("Analytical \nLab"=Analytical.Lab,
         "Method"=Standard.Method,
         "Calibration: \n Initial"=Cal.initial,
         "Calibration: \n Ongoing"=cal.ongoing,
         "Calibration: \n Blanks"=cal.blanks,
         "Detection \n Limit"=Method.Detection.Limit,
         "Reporting \n Limit"=Reporting.Limit)


tl.1<-flextable(tl.1) %>% 
  font(i = NULL, j = NULL, fontname="Arial", part = "all") %>% 
  theme_zebra() %>% 
  fontsize(size = 8, part="all")%>%
  autofit()
tl.1<-align(tl.1, i = NULL, j =(2:10) , align = "center", part = "all")%>%
  width(j=c(6:10), width = 0.8)%>%
  width(j=3:5, width=0.6)%>%
  width(j=1, width=1.2)
tl.1

```
\newpage
## Water Chemistry by PWL ID

```{r include=FALSE,message=FALSE,warning=FALSE}

#Chemistry figures for each analyte
library(stringr)
library(reshape2)
library(ggplot2)
library(ggthemes)
library(pander)
library(dplyr)
library(forcats)

chem_all$SH_PWL_ID<-as.factor(chem_all$SH_PWL_ID)
#take out the Rejected samples
chem_all<-chem_all %>% 
  filter(chem_all$validator_qualifiers!="R")

#merge with sites to get the order
#first just grab what we need
sites<-sites %>% 
  select(order,group,SH_SITE_ID) %>% 
  rename("SITE_ID"=SH_SITE_ID)

chem_all<-merge(chem_all,sites,by="SITE_ID")

#create units column
chem.trans<-subset(chem_all,chem_all$result_unit=="mg/l"|chem_all$result_unit=="ug/l"|chem_all$result_unit=="ntu")
chem.trans<-chem.trans %>% 
   arrange(order)

chem.trans$SH_PWL_ID<-fct_reorder(chem.trans$SH_PWL_ID, chem.trans$order)


chem.trans<-chem.trans%>%
  mutate(chemical_name=case_when(
    chemical_name=="CHLORIDE (AS CL)"~ "Chloride",
    chemical_name=="HARDNESS (AS CACO3)" ~"Hardness (as CaCO3)",
    chemical_name=="NITROGEN, NITRATE (AS N)" ~"Nitrate",
    chemical_name=="NITROGEN, NITRITE" ~ "Nitrite",
    chemical_name=="PHOSPHORUS, TOTAL (AS P)" ~ "Total Phosphorus",
    chemical_name=="TOTAL DISSOLVED SOLIDS (RESIDUE, FILTERABLE)" ~ "Total Dissolved Solids",
    chemical_name=="ALKALINITY, TOTAL (AS CaCO3)" ~ "Alkalinity",
    chemical_name=="NITROGEN, KJELDAHL, TOTAL" ~ "Total Kjeldahl Nitrogen",
    chemical_name=="Nitrate+Nitrite as Nitrogen" ~ "Nitrate+Nitrite",
    chemical_name=="Nitrogen, ammonia (As N)" ~ "Ammonia",
    chemical_name=="TURBIDITY" ~ "Turbidity",
    TRUE ~ as.character(chemical_name)
  ))%>%
  filter(chemical_name!="Nitrogen")

#chem.no.trans<-chem_all %>% 
  #filter(chem_all$result_unit != "mg/l"& chem_all$result_unit != "ug/l") %>% 
  # arrange(order)

#chem.no.trans$SH_PWL_ID<-fct_reorder(chem.no.trans$SH_PWL_ID, chem.no.trans$order)

#then probably need to merge with table that actually has metrics, bc we don't need to plot them all-or maybe we should?.

#chemp<-ggplot(chem_stat,aes(SiteID,mean))+geom_point()
#chemp+facet_wrap(~chemical_name,scales="free")+theme_bw()
```

```{r chemgraph1, echo=FALSE, fig.width=6, fig.height=4, message=FALSE, warning=FALSE, fig.cap=paste(unique(chem.trans$chemical_name), ", " , "The X-axis presents sampling locations from upstream to downstream and axis labels correspond with Table 1, Figure 1 and Figure 2. Point symbols match with WI/PWL segmentation as indicated in the plot legend. The total number of reported values illustrated for each sampling location can vary due to non-detection and QA/QC procedures. Descriptions of removed records are presented in Appendix III.", sep="")}
# create graphing function for those that need to be log10 (ug/L or mg/l-so not weird ones)
chem.graph <- function(df, na.rm = TRUE, ...){
  
  # create list of chmistry's in data to loop over 
  chem_list <- unique(df$chemical_name)
  l<-length(chem_list)
  for (i in seq_along(chem_list)) { 
    #order by group
    df<-df %>% 
       arrange(order)
    
    # create plot for each PWL in df 
    plot <- 
      ggplot(subset(df, df$chemical_name==chem_list[i]),
             aes(SH_PWL_ID,result_value,group=SH_PWL_ID,color=group))+ 
      
      geom_boxplot() +

      #scale_shape_manual(name="PWL Segment ID",values = 0:max(l))+
      
      theme_pander() +
      theme(axis.text.x = element_text(angle = 60, hjust = 1))+
      theme(legend.position="right") + 
      
      scale_y_log10(paste(df$chemical_name[df$chemical_name==chem_list[i]], df$result_unit[df$chemical_name==chem_list[i]], "log(10)")) + 
      xlab("Location ID")#+
     # ggtitle(paste(chem_list[i], ' \n', 
                    #"Chemical results by PWL ID",
                    #sep=''))
    
    # save plots as .png
    # ggsave(plot, file=paste(results, 
    #                        'projection_graphs/county_graphs/',
    #                        county_list[i], ".png", sep=''), scale=2)
   
    # save plots as .pdf
    # ggsave(plot, file=paste(results, 
    #                        'projection_graphs/county_graphs/',
    #                        county_list[i], ".pdf", sep=''), scale=2)
    
    # print plots to screen
    print(plot)
    cat('\n\n') 
    
  }
  
  
}

chem.graph(chem.trans) 

```



```{r  echo=FALSE, message=FALSE, warning=FALSE}
#Going to replace this function with graphs of the in situ data
#this one for the other values (no transformation of units)

# create graphing function for those that don't need to be log10

 
#chem.graph.n <- function(df, na.rm = TRUE, ...){
  
  # create list of chmistry's in data to loop over 
  #chem_list <- unique(df$chemical_name)
  #l<-length(df$SITE_ID)
  #for (i in seq_along(chem_list)) { 
    
    # create plot for each PWL in df 
   # plot <- 
   #   ggplot(subset(df, df$chemical_name==chem_list[i]),
         #    aes(SH_PWL_ID,result_value,group=SH_PWL_ID,color=group))+ 
      
    #  geom_boxplot() +
      #scale_shape_manual(name="PWL Segment ID",values = 0:max(l))+
      
     # theme_pander() +
     # theme(axis.text.x = element_text(angle = 60, hjust = 1))+
      #theme(legend.position="right") + 
      
     # scale_y_continuous(paste(df$chemical_name[df$chemical_name==chem_list[i]],df$result_unit[df$chemical_name==chem_list[i]])) + 
     # xlab("Location ID")#+
      #ggtitle(paste(chem_list[i], ' \n', 
                   # "Chemical results by PWL ID",
                   # sep=''))
    
    # save plots as .png
    # ggsave(plot, file=paste(results, 
    #                        'projection_graphs/county_graphs/',
    #                        county_list[i], ".png", sep=''), scale=2)
   
    # save plots as .pdf
    # ggsave(plot, file=paste(results, 
    #                        'projection_graphs/county_graphs/',
    #                        county_list[i], ".pdf", sep=''), scale=2)
    
    # print plots to screen
   # print(plot)
    
  #cat('\n\n')   
 # }
  
  
#}

#chem.graph.n(chem.no.trans)

```




